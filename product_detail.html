<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Product Detail</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <!-- Your custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div>
        <center><h1>Product-Details</h1></center>
    </div>
    <br>
    <div class="container">
        <div id="product-detail">
            <!-- Product details will be rendered here dynamically -->
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            fetch(`http://localhost:3000/api/products/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(product => {
                    renderProductDetail(product);
                    setupQuantityInput(product);
                    fetchRelatedProducts(product.category); // Fetch related products based on category
                })
                .catch(error => console.error('Error fetching product:', error));

            function renderProductDetail(product) {
                const productDetailContainer = document.getElementById('product-detail');
                productDetailContainer.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <img src="${product.image}" class="img img-fluid rounded mb-3" alt="Product Image">
                        </div>
                        <div class="col-md-6">
                            <div class="title mb-4">
                                <h3>${product.name}</h3>
                            </div>
                            <div class="category mb-4">
                                <span class="bg-light-gray p-2">${product.category}</span>
                            </div>
                            <div class="rating d-flex text-danger mb-4">
                                ${renderRating(product.rating)}
                            </div>
                            <div class="price mb-4">
                                <b>â‚¹${product.price}</b>
                            </div>
                            <div class="description mb-4">
                                <p>${product.description}</p>
                            </div>
                            <div class="qty_section border-top pt-2 mb-4">
                                <label>Quantity</label>
                                <div class="d-flex align-items-center">
                                    <button id="decreaseQtyBtn" class="btn btn-outline-secondary btn-sm">-</button>
                                    <input id="quantityInput" class="quantity text-center mx-2" min="1" max="10" value="1" type="number">
                                    <button id="increaseQtyBtn" class="btn btn-outline-secondary btn-sm">+</button>
                                </div>
                            </div>
                            <div class="buy mb-4">
                                <button id="addToCartBtn" class="btn btn-primary shadow">Add to Cart</button>
                                <a class="btn btn-primary shadow" href="cart.html">Go to Cart</a>
                            </div>
                        </div>
                    </div>
                    <section id="relatedProductsSection" class="related_products py-5 my-5">
                        <div class="title">
                            <h3>Related Products</h3>
                        </div>
                        <div id="relatedProducts" class="row mt-5">
                            <!-- Related products will be rendered here dynamically -->
                        </div>
                    </section>
                `;
                
                // Add event listener for Add to Cart button
                const addToCartBtn = document.getElementById('addToCartBtn');
                addToCartBtn.addEventListener('click', () => {
                    const quantity = document.getElementById('quantityInput').value;
                    const cartItem = {
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: parseInt(quantity),
                        image: product.image // Include product image in cart item
                    };
                    addToCart(cartItem);
                });
            }

            function renderRating(rating) {
                const fullStars = '<i class="fas fa-star"></i>'.repeat(rating);
                const emptyStars = '<i class="far fa-star"></i>'.repeat(5 - rating);
                return `${fullStars}${emptyStars}`;
            }

            function setupQuantityInput(product) {
                const quantityInput = document.getElementById('quantityInput');
                const decreaseQtyBtn = document.getElementById('decreaseQtyBtn');
                const increaseQtyBtn = document.getElementById('increaseQtyBtn');

                decreaseQtyBtn.addEventListener('click', () => {
                    if (quantityInput.value > 1) {
                        quantityInput.value = parseInt(quantityInput.value) - 1;
                    }
                });

                increaseQtyBtn.addEventListener('click', () => {
                    if (quantityInput.value < 10) {
                        quantityInput.value = parseInt(quantityInput.value) + 1;
                    }
                });
            }

            function fetchRelatedProducts(category) {
                fetch(`http://localhost:3000/api/products?category=${category}&limit=3`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(products => {
                        renderRelatedProducts(products);
                    })
                    .catch(error => console.error('Error fetching related products:', error));
            }

            function renderRelatedProducts(relatedProducts) {
                const relatedProductsContainer = document.getElementById('relatedProducts');
                relatedProductsContainer.innerHTML = relatedProducts.map(product => `
                    <div class="col-md-4 col-6 mb-4">
                        <div class="border border-dark rounded shadow text-center p-3">
                            <img src="${product.image}" class="img img-fluid mb-3" alt="${product.name}">
                            <h5>${product.name}</h5>
                            <a href="product_detail.html?id=${product.id}" class="btn btn-outline-primary btn-sm">View Details</a>
                        </div>
                    </div>
                `).join('');
            }

            function addToCart(item) {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                const existingItemIndex = cart.findIndex(cartItem => cartItem.id === item.id);

                if (existingItemIndex !== -1) {
                    // Item already exists in cart, update quantity
                    cart[existingItemIndex].quantity += item.quantity;
                } else {
                    // Add new item to cart
                    cart.push(item);
                }

                // Update localStorage
                localStorage.setItem('cart', JSON.stringify(cart));

                // Update cart count
                updateCartCount();
            }

            function updateCartCount() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
                document.getElementById('cartCount').innerText = cartCount;
            }
        });
    </script>
</body>
</html>
